<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Contenido de FAQs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Inter', sans-serif; }
        .tree-item-content:hover { background-color: #f0f4f8; }
        .tree-item.selected > .tree-item-content { background-color: #e0e7ff; font-weight: 600; }
        .wysiwyg-btn {
            border: 1px solid #d1d5db; padding: 0.5rem; border-radius: 0.375rem; margin-right: 0.25rem; background-color: white;
        }
        .wysiwyg-btn:hover { background-color: #f3f4f6; }
        #answer-editor {
            border: 1px solid #d1d5db; padding: 0.75rem; border-radius: 0.375rem; min-height: 200px;
            background-color: white; outline: none;
        }
        .drag-over-folder > .tree-item-content { background-color: #dbeafe !important; border: 2px dashed #60a5fa; }
        .drag-over-item-top > .tree-item-content { border-top: 2px solid #3b82f6; }
        .dragging { opacity: 0.5; background-color: #e0e7ff; }
        .tree ul { padding-left: 20px; border-left: 1px solid #e5e7eb; }
        .tree-item.collapsed > ul { display: none; }
        .toggler { cursor: pointer; width: 20px; text-align: center; transition: transform 0.2s; }
        .tree-item.collapsed > .tree-item-content .toggler { transform: rotate(-90deg); }
        .id-error { border-color: #ef4444 !important; }
        .id-error-message { color: #ef4444; font-size: 0.875rem; }
        .resizer {
            width: 10px;
            cursor: col-resize;
            background-color: #e5e7eb;
            z-index: 10;
        }
        .resizer:hover {
             background-color: #60a5fa;
        }
        #save-toast {
            transition: transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Save Toast -->
    <div id="save-toast" class="fixed top-5 right-5 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full z-50">
        <i class="fas fa-check-circle mr-2"></i>¬°Guardado!
    </div>

    <!-- Custom Modal -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="modal-title" class="text-lg font-bold mb-4">Confirmaci√≥n</h3>
            <p id="modal-text" class="mb-6">¬øEst√°s seguro?</p>
            <div class="flex justify-end gap-4">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancelar</button>
                <button id="modal-confirm" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>
    
    <div class="p-4 flex flex-col h-screen">
        <header class="mb-4 text-center flex-shrink-0">
            <h1 class="text-4xl font-extrabold text-gray-900">Editor de Contenido de FAQs</h1>
        </header>

        <div id="main-content" class="flex md:flex-row bg-white rounded-2xl shadow-xl overflow-hidden flex-grow min-h-0">
            <!-- Left Pane: Tree View -->
            <div id="left-pane" class="w-2/5 p-6 flex flex-col flex-shrink-0">
                <div class="flex justify-between items-center mb-1">
                    <h2 class="text-2xl font-bold">Estructura</h2>
                    <button id="add-root-category-btn" title="A√±adir nueva categor√≠a ra√≠z" class="px-3 py-1 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-sm font-semibold flex items-center gap-2 hidden">
                        <i class="fas fa-plus"></i> Nueva Categor√≠a
                    </button>
                </div>
                 <div class="flex items-center gap-2 mb-4">
                    <button id="expand-all-btn" class="text-xs text-blue-600 hover:underline">Expandir Todo</button>
                    <span class="text-gray-300">|</span>
                    <button id="collapse-all-btn" class="text-xs text-blue-600 hover:underline">Contraer Todo</button>
                </div>
                <div id="tree-container" class="flex-grow overflow-y-auto tree pr-2"></div>
                 <div class="mt-auto pt-6 border-t border-gray-200 flex-shrink-0">
                    <label for="file-upload" class="cursor-pointer w-full text-center block px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 font-semibold">
                        <i class="fas fa-upload mr-2"></i> Cargar faqs.json
                    </label>
                    <input id="file-upload" type="file" class="hidden" accept=".json">
                    <button id="export-json-btn" class="mt-2 w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold transition-colors">
                        <i class="fas fa-download mr-2"></i> Exportar a JSON
                    </button>
                </div>
            </div>

            <!-- Resizer Handle -->
            <div id="resizer" class="resizer"></div>
            
            <!-- Right Pane: Editing Form -->
            <div id="right-pane" class="flex-grow p-8 flex flex-col min-w-0">
                <div id="welcome-message" class="flex flex-col items-center justify-center h-full text-center p-8">
                    <i class="fas fa-hand-pointer text-6xl text-gray-300 mb-6"></i>
                    <h3 class="text-2xl font-bold text-gray-600">Bienvenido al Editor de FAQs</h3>
                    <div class="text-left max-w-md mx-auto mt-4 text-gray-500 space-y-4">
                       <p><i class="fas fa-folder text-indigo-500 mr-2"></i><strong>Categor√≠a:</strong> Es una carpeta para agrupar FAQs relacionadas. Una categor√≠a puede contener otras categor√≠as o FAQs.</p>
                       <p><i class="fas fa-file-alt text-indigo-500 mr-2"></i><strong>FAQ:</strong> Es una pregunta y su respuesta. Las FAQs viven dentro de las categor√≠as.</p>
                       <p><i class="fas fa-mouse-pointer mr-2"></i><strong>Para empezar:</strong> Carga un archivo `faqs.json` usando el bot√≥n de abajo a la izquierda para comenzar a editar.</p>
                    </div>
                </div>

                <div id="form-container" class="hidden flex-col h-full">
                    <div class="flex-shrink-0">
                        <div id="breadcrumbs" class="text-sm text-gray-500 mb-4 truncate"></div>
                    </div>
                    <div class="flex-grow overflow-y-auto pr-4 -mr-4 min-h-0">
                        <div class="mb-6">
                            <label for="title" class="block text-sm font-medium text-gray-700 mb-1">T√≠tulo</label>
                            <input type="text" id="title" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="mb-6">
                            <label for="id" class="block text-sm font-medium text-gray-700 mb-1">ID (Obligatorio para FAQs)</label>
                            <input type="text" id="id" class="w-full p-2 border border-gray-300 rounded-md bg-gray-50 text-gray-500 shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <p id="id-error-msg" class="id-error-message mt-1 hidden">El ID es obligatorio para las FAQs.</p>
                        </div>
                        
                        <div id="answer-section" class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Respuesta</label>
                            <div class="wysiwyg-toolbar mb-2 flex items-center relative">
                                 <button class="wysiwyg-btn" data-command="bold" title="Negrita"><i class="fas fa-bold"></i></button>
                                 <button class="wysiwyg-btn" data-command="italic" title="Cursiva"><i class="fas fa-italic"></i></button>
                                 <button class="wysiwyg-btn" id="create-link-btn" title="Enlace"><i class="fas fa-link"></i></button>
                                 <button class="wysiwyg-btn" id="emoji-btn" title="Emoji"><i class="fas fa-smile"></i></button>
                                 <div id="emoji-picker" class="absolute top-12 left-0 bg-white border rounded-lg shadow-lg p-2 grid grid-cols-8 gap-1 hidden z-10 w-64"></div>
                            </div>
                            <div id="answer-editor" contenteditable="true"></div>
                        </div>

                        <details class="bg-gray-50 p-4 rounded-lg mb-6">
                            <summary class="font-semibold cursor-pointer text-gray-700">Detalles T√©cnicos</summary>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <div>
                                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n</label>
                                    <textarea id="description" rows="2" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                                </div>
                                <div>
                                    <label for="icon" class="block text-sm font-medium text-gray-700 mb-1">Icono</label>
                                    <input type="text" id="icon" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label for="action" class="block text-sm font-medium text-gray-700 mb-1">Acci√≥n</label>
                                    <input type="text" id="action" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label for="track_event" class="block text-sm font-medium text-gray-700 mb-1">Track Event (Amplitude)</label>
                                    <input type="text" id="track_event" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                            </div>
                        </details>
                    </div>
                    
                    <div class="flex-shrink-0 justify-between items-center mt-auto pt-6 border-t border-gray-200 flex">
                        <div id="add-buttons-container" class="flex gap-2">
                             <button id="add-subcategory-btn" class="px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-semibold text-sm">A√±adir Subcategor√≠a</button>
                             <button id="add-faq-btn" class="px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-semibold text-sm">A√±adir FAQ</button>
                        </div>
                        <div class="flex gap-4">
                             <button id="delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-semibold">Eliminar</button>
                             <button id="save-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-semibold">Guardar Cambios</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    let faqData = [];
    let selectedItem = null;
    let selectedElement = null;
    let draggedItemPath = null;

    // --- DOM Elements ---
    const treeContainer = document.getElementById('tree-container');
    const welcomeMessage = document.getElementById('welcome-message');
    const formContainer = document.getElementById('form-container');
    const breadcrumbs = document.getElementById('breadcrumbs');
    const titleInput = document.getElementById('title');
    const idInput = document.getElementById('id');
    const answerEditor = document.getElementById('answer-editor');
    const descriptionInput = document.getElementById('description');
    const iconInput = document.getElementById('icon');
    const actionInput = document.getElementById('action');
    const trackEventInput = document.getElementById('track_event');
    const saveBtn = document.getElementById('save-btn');
    const deleteBtn = document.getElementById('delete-btn');
    const addSubcategoryBtn = document.getElementById('add-subcategory-btn');
    const addFaqBtn = document.getElementById('add-faq-btn');
    const addRootCategoryBtn = document.getElementById('add-root-category-btn');
    const fileUpload = document.getElementById('file-upload');
    const exportJsonBtn = document.getElementById('export-json-btn');
    const answerSection = document.getElementById('answer-section');
    const idErrorMsg = document.getElementById('id-error-msg');
    const addButtonsContainer = document.getElementById('add-buttons-container');
    const expandAllBtn = document.getElementById('expand-all-btn');
    const collapseAllBtn = document.getElementById('collapse-all-btn');
    const saveToast = document.getElementById('save-toast');
    
    // Resizer Elements
    const leftPane = document.getElementById('left-pane');
    const resizer = document.getElementById('resizer');
    
    // Emoji Picker Elements
    const emojiBtn = document.getElementById('emoji-btn');
    const emojiPicker = document.getElementById('emoji-picker');

    // Modal Elements
    const modal = document.getElementById('custom-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalText = document.getElementById('modal-text');
    const modalConfirm = document.getElementById('modal-confirm');
    const modalCancel = document.getElementById('modal-cancel');
    let confirmCallback = null;

    const emojis = ['üòä', 'üòÇ', 'üòç', 'ü§î', 'üëç', 'üëé', '‚ù§Ô∏è', '‚úÖ', '‚ùå', 'üëâ', 'üìé', 'üí∏', 'üì≤', 'üìå', '‚ú®', 'üéâ', 'üöÄ', 'üí°', 'üî•', '‚úîÔ∏è'];

    // --- Resizer Logic ---
    let isResizing = false;
    resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', () => {
            isResizing = false;
            document.body.style.cursor = 'default';
            document.body.style.userSelect = 'auto';
            document.removeEventListener('mousemove', handleMouseMove);
        });
    });

    function handleMouseMove(e) {
        if (!isResizing) return;
        const mainContent = document.getElementById('main-content');
        const totalWidth = mainContent.offsetWidth;
        const leftWidth = e.clientX - mainContent.offsetLeft;
        const newLeftPaneWidth = (leftWidth / totalWidth) * 100;
        
        if (newLeftPaneWidth > 20 && newLeftPaneWidth < 80) { // Set min/max width
            leftPane.style.width = `${newLeftPaneWidth}%`;
        }
    }

    // --- Toast/Notification Logic ---
    function showSaveToast() {
        saveToast.classList.remove('translate-x-full');
        setTimeout(() => {
            saveToast.classList.add('translate-x-full');
        }, 2000);
    }


    // --- Modal Logic ---
    function showModal(title, text, onConfirm) {
        modalTitle.textContent = title;
        modalText.textContent = text;
        confirmCallback = onConfirm;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function hideModal() {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        confirmCallback = null;
    }

    modalConfirm.addEventListener('click', () => {
        if (confirmCallback) {
            confirmCallback();
        }
        hideModal();
    });
    modalCancel.addEventListener('click', hideModal);

    // --- Data and Tree Rendering ---
    function renderTree(data, parentElement, level = 0, path = []) {
        const list = document.createElement('ul');
        if (level > 0) list.style.marginLeft = '0px';

        data.forEach((item, index) => {
            const currentPath = [...path, index];
            const isCategory = item.menu && Array.isArray(item.menu);
            
            const listItem = document.createElement('li');
            listItem.classList.add('tree-item');
            listItem.dataset.path = JSON.stringify(currentPath);

            const contentDiv = document.createElement('div');
            contentDiv.classList.add('tree-item-content', 'p-2', 'rounded-md', 'my-1', 'flex', 'items-center', 'cursor-pointer');
            
            const togglerContainer = document.createElement('span');
            togglerContainer.className = 'toggler-container w-5 flex-shrink-0';
            
            if (isCategory) {
                const toggler = document.createElement('span');
                toggler.className = 'toggler';
                toggler.innerHTML = '<i class="fas fa-chevron-down text-gray-400"></i>';
                toggler.addEventListener('click', (e) => {
                    e.stopPropagation();
                    listItem.classList.toggle('collapsed');
                });
                togglerContainer.appendChild(toggler);
            }
            contentDiv.appendChild(togglerContainer);

            const icon = document.createElement('i');
            const iconClass = isCategory ? 'fa-folder' : 'fa-file-alt';
            icon.className = `fas ${iconClass} mr-2 text-indigo-500 flex-shrink-0`;
            contentDiv.appendChild(icon);

            const titleSpan = document.createElement('span');
            titleSpan.className = 'flex-grow truncate';
            titleSpan.textContent = item.title || 'Sin T√≠tulo';
            contentDiv.appendChild(titleSpan);
            
            contentDiv.addEventListener('click', (e) => {
                e.stopPropagation();
                selectItem(item, listItem, currentPath);
                if (isCategory) {
                    listItem.classList.toggle('collapsed');
                }
            });

            // Drag and Drop Logic
            contentDiv.draggable = true;
            contentDiv.addEventListener('dragstart', (e) => {
                e.stopPropagation();
                draggedItemPath = currentPath;
                e.dataTransfer.setData('text/plain', null);
                e.currentTarget.classList.add('dragging');
            });
            contentDiv.addEventListener('dragend', (e) => e.currentTarget.classList.remove('dragging'));
            
            contentDiv.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                if(isCategory) {
                    listItem.classList.add('drag-over-folder');
                } else {
                     listItem.classList.add('drag-over-item-top');
                }
            });
            contentDiv.addEventListener('dragleave', (e) => {
                e.stopPropagation();
                listItem.classList.remove('drag-over-folder');
                listItem.classList.remove('drag-over-item-top');
            });
            contentDiv.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                listItem.classList.remove('drag-over-folder');
                listItem.classList.remove('drag-over-item-top');
                if (!draggedItemPath) return;

                const targetPath = currentPath;
                const draggedItemParent = getParentFromPath(draggedItemPath);
                const draggedItemIndex = draggedItemPath[draggedItemPath.length - 1];
                const [draggedItem] = draggedItemParent.menu.splice(draggedItemIndex, 1);
                
                if (isCategory) { // Dropped on a folder, move inside
                    item.menu.push(draggedItem);
                } else { // Dropped on an item, reorder
                    const targetParent = getParentFromPath(targetPath);
                    const targetIndex = targetPath[targetPath.length - 1];
                    targetParent.menu.splice(targetIndex, 0, draggedItem);
                }

                refreshTree();
                deselectAll();
                draggedItemPath = null;
            });
            
            listItem.appendChild(contentDiv);
            list.appendChild(listItem);

            if (isCategory && item.menu.length > 0) {
                renderTree(item.menu, listItem, level + 1, currentPath);
            }
        });
        parentElement.appendChild(list);
    }
    
    function refreshTree() {
        const currentPathStr = selectedElement ? selectedElement.dataset.path : null;
        treeContainer.innerHTML = '';
        renderTree(faqData, treeContainer);
        if (currentPathStr) {
            const reselectedElement = document.querySelector(`[data-path='${currentPathStr}']`);
            if (reselectedElement) {
                reselectedElement.classList.add('selected');
                selectedElement = reselectedElement;
            }
        }
    }
    
    function toggleAll(collapse) {
        const allItems = treeContainer.querySelectorAll('.tree-item');
        allItems.forEach(item => {
            const path = JSON.parse(item.dataset.path);
            const dataItem = getItemFromPath(path);
            if (dataItem && dataItem.menu && Array.isArray(dataItem.menu)) {
                if (collapse) {
                    item.classList.add('collapsed');
                } else {
                    item.classList.remove('collapsed');
                }
            }
        });
    }

    expandAllBtn.addEventListener('click', () => toggleAll(false));
    collapseAllBtn.addEventListener('click', () => toggleAll(true));


    // --- Item Selection and Form Population ---
    function selectItem(item, element, path) {
        if (selectedElement) selectedElement.classList.remove('selected');
        selectedItem = item;
        selectedElement = element;
        selectedElement.classList.add('selected');
        
        populateForm(item, path);
        welcomeMessage.classList.add('hidden');
        formContainer.classList.remove('hidden');
        formContainer.classList.add('flex');
    }

    function populateForm(item, path) {
        idInput.classList.remove('id-error');
        idErrorMsg.classList.add('hidden');

        titleInput.value = item.title || '';
        idInput.value = item.id || '';
        answerEditor.innerHTML = item.answer || '';
        descriptionInput.value = item.description || '';
        iconInput.value = item.icon || '';
        actionInput.value = item.action || '';
        trackEventInput.value = item.track_event || '';

        let breadcrumbPath = 'Inicio';
        let currentLevel = { menu: faqData };
        path.forEach(index => {
            if(currentLevel.menu[index]) {
               breadcrumbPath += ` > ${currentLevel.menu[index].title}`;
               currentLevel = currentLevel.menu[index];
            }
        });
        breadcrumbs.textContent = breadcrumbPath;

        const isCategory = item.menu && Array.isArray(item.menu);
        answerSection.style.display = isCategory ? 'none' : 'block';
        addButtonsContainer.style.visibility = isCategory ? 'visible' : 'hidden';
    }
    
    function deselectAll() {
        if (selectedElement) selectedElement.classList.remove('selected');
        selectedItem = null;
        selectedElement = null;
        welcomeMessage.classList.remove('hidden');
        formContainer.classList.add('hidden');
        formContainer.classList.remove('flex');
    }

    // --- CRUD Operations ---
    function getItemFromPath(path) {
        let item = { menu: faqData };
        path.forEach(index => {
            if (item && item.menu && item.menu[index]) {
                item = item.menu[index];
            } else {
                item = null;
                return;
            }
        });
        return item;
    }
    
    function getParentFromPath(path) {
        if (path.length <= 1) return { menu: faqData };
        let parent = { menu: faqData };
        path.slice(0, -1).forEach(index => {
            parent = parent.menu[index];
        });
        return parent;
    }

    function validateAndSave() {
        if(!selectedItem) return true; // Nothing to save, so validation passes
        const isCategory = selectedItem.menu && Array.isArray(selectedItem.menu);
        if (!isCategory && !idInput.value.trim()) {
            idInput.classList.add('id-error');
            idErrorMsg.classList.remove('hidden');
            return false;
        }

        selectedItem.title = titleInput.value;
        selectedItem.id = idInput.value || null;
        selectedItem.description = descriptionInput.value || null;
        selectedItem.icon = iconInput.value || null;
        selectedItem.action = actionInput.value || null;
        selectedItem.track_event = trackEventInput.value || null;
        
        if (!isCategory) {
            selectedItem.answer = answerEditor.innerHTML || null;
        }
        
        refreshTree();
        showSaveToast();
        return true;
    }

    saveBtn.addEventListener('click', validateAndSave);
    idInput.addEventListener('input', () => {
        if (idInput.value.trim()){
            idInput.classList.remove('id-error');
            idErrorMsg.classList.add('hidden');
        }
    });

    deleteBtn.addEventListener('click', () => {
        if (!selectedItem) return;
        showModal('Confirmar Eliminaci√≥n', '¬øEst√°s seguro de que quieres eliminar este √≠tem y todo su contenido?', () => {
            const path = JSON.parse(selectedElement.dataset.path);
            const parent = getParentFromPath(path);
            const index = path[path.length - 1];
            
            parent.menu.splice(index, 1);
            
            refreshTree();
            deselectAll();
        });
    });
    
    function createNewItem(type) {
         if (!selectedItem || !selectedElement) return;
         const isCategory = selectedItem.menu && Array.isArray(selectedItem.menu);
         if (!isCategory) return;
        
         const newItem = {
            id: null,
            title: `Nueva ${type}`,
            description: null,
            track_event: null,
            track_property: null,
            icon: null,
            action: type === 'faq' ? 'GO_TO_DOUBLE_CHANNEL' : null,
            answerTitle: null,
            answer: null,
            menu_title: null,
            menu: type === 'categor√≠a' ? [] : null
        };
        
        if(!selectedItem.menu) {
            selectedItem.menu = [];
        }

        const parentPath = JSON.parse(selectedElement.dataset.path);
        const newIndex = selectedItem.menu.length;
        const newPath = [...parentPath, newIndex];
        
        selectedItem.menu.push(newItem);
        
        selectedElement.classList.remove('collapsed');

        refreshTree();
        
        const newElement = document.querySelector(`[data-path='${JSON.stringify(newPath)}']`);
        if (newElement) {
            selectItem(newItem, newElement, newPath);
        }
    }
    addSubcategoryBtn.addEventListener('click', () => createNewItem('categor√≠a'));
    addFaqBtn.addEventListener('click', () => createNewItem('faq'));
    
    addRootCategoryBtn.addEventListener('click', () => {
         const newItem = {
            id: null,
            title: `Nueva Categor√≠a Ra√≠z`,
            description: null,
            track_event: null,
            track_property: null,
            icon: null,
            action: null,
            answerTitle: null,
            answer: null,
            menu_title: null,
            menu: []
        };
        faqData.push(newItem);
        refreshTree();
    });

    // --- File Handling ---
    fileUpload.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    faqData = JSON.parse(e.target.result);
                    refreshTree();
                    deselectAll();
                    addRootCategoryBtn.classList.remove('hidden');
                } catch (err) {
                    showModal('Error de Archivo', 'No se pudo procesar el archivo JSON. Por favor, verifica su formato.');
                }
            };
            reader.readAsText(file);
        }
    });

    exportJsonBtn.addEventListener('click', () => {
        if (validateAndSave()) {
            const jsonString = JSON.stringify(faqData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'faqs_exportado.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    });
    
    // --- WYSIWYG Editor & Emoji Picker ---
    document.querySelectorAll('.wysiwyg-toolbar .wysiwyg-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            const command = btn.dataset.command;
            if (command) {
                document.execCommand(command, false, null);
                answerEditor.focus();
            }
        });
    });
    
    document.getElementById('create-link-btn').addEventListener('click', (e) => {
        const url = prompt('Ingresa la URL:');
        if (url) {
            document.execCommand('createLink', false, url);
        }
        answerEditor.focus();
    });

    function buildEmojiPicker() {
        emojis.forEach(emoji => {
            const emojiSpan = document.createElement('span');
            emojiSpan.textContent = emoji;
            emojiSpan.className = 'cursor-pointer p-1 text-2xl hover:bg-gray-200 rounded-md';
            emojiSpan.addEventListener('click', () => {
                answerEditor.focus();
                document.execCommand('insertText', false, emoji);
                emojiPicker.classList.add('hidden');
            });
            emojiPicker.appendChild(emojiSpan);
        });
    }

    emojiBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        emojiPicker.classList.toggle('hidden');
    });

    document.addEventListener('click', (e) => {
        if (!emojiPicker.classList.contains('hidden') && !emojiPicker.contains(e.target) && e.target !== emojiBtn) {
            emojiPicker.classList.add('hidden');
        }
    });

    buildEmojiPicker();
});
</script>
</body>
</html>

